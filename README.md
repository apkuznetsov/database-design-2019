# Проектирование баз данных (2019)

1. [Построение схемы базы данных с использованием модели сущность-связь](#db10)
2. [Запросы](#db11)
3. [Использование подзапросов и представлений](#db12)
4. [Работа с транзакциями](#db13)
5. [Логическое проектирование баз данных](#db20)
6. [Создание таблиц и ограничений целостности. Использование команд SQL для работы с данными, хранящимися в таблицах](#db21)
7. [Создание и использование хранимых процедур и функций](#db22)
8. [Создание и использование тригеров и курсоров](#db23)
9. [Разработка системы защиты информации на основе привилегий](#db4)
10. [Проектирование распределённой базы данных](#db30)

## Построение схемы базы данных с использованием модели сущность-связь. <a name="db10"></a>
Приобретение навыков анализа предметной области, построение модели сущность-связь для заданной предметной области.

### Предметная область: 
Учебно-методический отдел (расписание занятий).

### Основные предметно-значимые сущности: 
Дисциплины, Аудитории, Группы студентов, Преподаватели.

### Основные предметно-значимые атрибуты сущностей:
*	дисциплины – название;
*	аудитории – название или номер аудитории;
*	группы студентов – название или номер группы;
*	преподаватели – фамилия, имя, отчество.

### Основные требования к функциям системы:
*	выбрать все занятия с указанием аудитории по группам или определенной группе;
*	подсчитать количество часов занятий в неделю по группам или определенной группе;
*	выбрать все занятия с указанием аудиторий по преподавателям или определенному преподавателю;
*	подсчитать количество часов занятий по преподавателям или определенному преподавателю;
*	выбрать все дисциплины, которые не указаны в расписании;
*	выбрать всех преподавателей, которые не указаны в расписании;
*	подсчитать общее количество часов занятий в неделю по аудиториям или определенной аудитории.
 
### Последовательность выполнения работы:
1)	выделите необходимый набор сущностей, отражающих предметную область (в соответствии с вариантом задания) и информационные потребности пользователей;
2)	определите необходимый набор атрибутов сущностей и классифицировать их по типу (идентифицирующие, описательные, простые, составные и т.д.);
3)	определите альтернативные и первичные ключи сущностей;
4)	определите связи между сущностями;
5)	проанализировав структуру связей, исключить избыточные;
6)	укажите необходимые свойства связей;
7)	определите тип сущности (стержневая, ассоциативная, характеризующая и т.д.);
8)	задайте необходимые ограничения целостности данных;
9)	постройте первичную схему БД (используя нотацию Питера Чена);
10)	 оформите отчет о выполнении лабораторной работы.

### Схема базы данных. Основные предметно-значимые сущности: 
*	дисциплина, 
*	аудитория, 
*	группа студентов, 
*	преподаватель,
*	расписание.

### Информационные потребности пользователей: 
1)	выбрать все занятия с указанием аудитории по группам или определенной группе;
2)	подсчитать количество часов занятий в неделю по группам или определенной группе;
3)	выбрать все занятия с указанием аудиторий по преподавателям или определенному преподавателю;
4)	подсчитать количество часов занятий по преподавателям или определенному преподавателю;
5)	выбрать все дисциплины, которые не указаны в расписании;
6)	выбрать всех преподавателей, которые не указаны в расписании;
7)	подсчитать общее количество часов занятий в неделю по аудиториям или определенной аудитории.

### Основные предметно-значимые атрибуты сущностей:
1)	дисциплина – название – идентифицирующий атрибут;
2)	аудитория – номер аудитории – идентифицирующий атрибут;
3)	группа студентов – номер группы – идентифицирующий атрибут;
4)	преподаватель – табельный номер – идентифицирующий атрибут; фамилия, имя, отчество – составной описательный атрибут;
5)	занятие – день недели – идентифицирующий атрибут; время – описательный атрибут.

### Альтернативные (АК) и первичные ключи (ПК) сущности:
1)	дисциплины – название – ПК;
2)	аудитории – номер аудитории – ПК;
3)	группы студентов – номер группы – ПК;
4)	преподаватели – табель номер – ПК; фамилия – АК, имя – АК, отчество – АК;
5)	занятие – день недели – ПК; время – АК.

### Тип сущностей:
1)	дисциплины – ассоциативная;
2)	аудитории – ассоциативная;
3)	группы студентов – ассоциативная;
4)	преподаватели – ассоциативная;
5)	занятие – стержневая.

### Ограничения целостности данных:
1)	дисциплина – строка, не должна содержать цифр;
2)	номер аудитории – положительное трёхзначное значение;
3)	номер группы – положительное четырёхзначное значение;
4)	табельный номер – положительное трёхзначное значение;
5)	фамилия, имя, отчество – строки, не должны содержать цифр, каждое слово начинается с заглавной буквы;
6)	день недели – один из дней недели формата «ПН»;
7)	время – формат «00:00».

### Свойства связей:
1)	бинарная полная связь между сущностями Преподаватель и Занятие является 1:1 по мощности;
2)	бинарная полная связь между сущностями Группа студентов и Занятие является 1:1 по мощности;
3)	бинарная полная связь между сущностями Занятие и Дисциплина является 1:1 по мощности;
4)	бинарная полная связь между сущностями Занятие и Аудитория является 1:1 по мощности.

<img src="/about/university-logical-model.png ">

## Запросы <a name="db11"></a>

### Придумайте и напишите SQL запросы, которые будут необходимы для предметной области (в соответствии с вариантом задания):
* Запрос на выборку избранных полей таблицы, с использованием синонима (алиаса) и сортировкой записей (ORDER BY).
* Запрос с использованием сортировки (ORDER BY) и группировки (GROUP BY).
* Запрос с использованием предложения DISTINCT.
* Запрос с использованием операций сравнения.
* Запросы для предикатов: IN, BETWEEN, LIKE, IS NULL.
* Запросы с использованием агрегатных функций (COUNT, SUM, AVG, MAX, MIN ), производящие обобщенную групповую обработку значений полей (используя ключевые фразы GROUP BY и HAVING).
* Запрос на выборку данных из двух связанных таблиц. Выбрать несколько полей, по которым сортируется вывод.
* Многотабличный запрос с использованием внутреннего и внешнего соединения.
* Многотабличный запрос с использованием оператора UNION.
* Напишите SQL запросы, предусмотренные вариантом задания.
* Создайте SQL команды для модификации данных (INSERT, UPDATE, DELETE).

## Использование подзапросов и представлений <a name="db12"></a>
Приобретение навыков использования подзапросов в команде SQL SELECT. Создание и работа с представлениями.

### Придумайте и напишите SQL запросы, которые будут необходимы для предметной области (в соответствии с вариантом задания):
* Запрос с применением подзапроса в части WHERE команды SQL SELECT и в внутри предложения HAVING.
* Запрос с применением подзапроса с применением следующих операторов: ALL, EXIST, ANY.
* Создайте представления, основанные на запросах из пункта 1.
* Создайте представления с выборкой, сортировкой, группировкой, левым, правым и внешним объединением.
* Создайте обновляемые представления для всех таблиц. Проверьте работоспособность созданных представлений командами SQL: Select, Insert, Update и Delete.
* Для обновляемого представления примените команду WITH CHECK OPTION. Объясните смысл ее применения.

## Работа с транзакциями <a name="db13"></a>
Изучение механизма формирования транзакций.

### Содержание работы: 
изучение основ создания транзакций, сохранения изменений, выполнения операций транзакции, организации отката в случае ошибки.

### Ход работы:
* Выберите любую таблицу, созданную в предыдущих лабораторных работах;
* Отключите режим автоматического завершения;
* Добавьте в выбранную таблицу новые записи, проверьте добавились ли они;
* Произведите откат транзакции, т. е. отмену произведенных действий;
* Откатите транзакцию оператором ROLLBACK(изменения не сохранились);
* Воспроизведите транзакцию и сохраните действия оператором COMMIT.


---------
## Логическое проектирование баз данных <a name="db20"></a>
Приобретение навыков анализа и моделирования предметной области, построение структурированных наборов данных в рамках реляционной модели данных. Приобретение навыков нормализации отношений.
### Предметная область
База данных, поддерживающая информационную систему аэропорта.
### Основные предметно-значимые сущности
Член экипажа, Экипаж, Самолёт, Рейс, Кассир, Билет, Пассажир.
### Основные предметно-значимые атрибуты сущностей
1. Член экипажа: Табельный номер, ФИО, Количество вылетов, Должность, Номер экипажа, Группа допуска.
2. Экипаж: Номер экипажа, Группа допуска.
3. Самолёт: Бортовой номер, Модель.
4. Модель: Группа допуска, Скорость, Потолок, Взлётная масса, Количество посадочных мест, Топливо, Длина разбега.
5. Рейс: Номер рейса, Место назначения, Дата вылета, Дата прибытия, Бортовой номер.
6. Кассир: Табельный номер_кассира, ФИО.
7. Билет: Номер билета, Цена, Табельный номер кассира, Серия и номер паспорта пассажира, Номер рейса.
8. Пассажир: Серия и номер паспорта пассажира, ФИО пассажира.
### Основные требования к функциям системы
В зависимости от марки самолета выбирается экипаж, имеющий соответствующую группу допуска управления воздушным судном. Для диспетчерской службы важным является номер экипажа. Каждый экипаж состоит из нескольких человек, каждый из которых имеет личные данные и должность. На определенный срок диспетчеры составляют плановое расписание полетов самолетов. Расписание составляется не только для диспетчерской службы аэропорта, но и для информационного обеспечения потенциальных пассажиров. Чтобы обладать достаточной информативностью для пользователей в расписание должны входить следующие данные: номер рейса, название рейса, день вылета, время вылета, время прибытия.

Непосредственная динамическая информация о состоянии полета воздушных судов по заданным направлениям должна аккумулироваться и предоставляться пользователям в наглядной и информационно полной форме. Для предоставления таких услуг со стороны БД необходимо содержание в ней отношения «Вылеты», содержащего следующие атрибуты: Код вылета, код экипажа, номер рейса, код самолета, день вылета.
### Ограничения целостности данных
1. ФИО (фамилия, имя, отчество): три слова, в них могут содержаться только русские буквы и дефис.
2. Все номера: числа от 10000 до 99999.
3. Количество вылетов: положительное целое число.
4. Должность: одна из следующих — командир или второй пилот.
5. Модель: строка.
6. Скорость: измеряется в км/ч, положительное число.
7. Высота: измеряется в м, положительное число.
8. Взлётная масса: измеряется в кг, положительное число.
9. Количество посадочных мест: положительное целое число.
10. Топливо: строка.
11. Длина разбега: измеряется в м, положительное число.
12. Место назначения: строка.
13. Дата: дата.
14. Цена: положительное целое число.
15. Серия и номер паспорта: десятизначное число от 1000000000 до 9999999999.
### Связи
1. Член экипажа и Экипаж – M:1.
2. Экипаж и Рейс – 1:M.
3. Модель и Самолёт – 1:1.
4. Самолёт и Рейс – 1:M.
5. Кассир и Билет – 1:M.
6. Пассажир и Билет – 1:M.
### Логическая и физическая модель предметной области
<img src="/about/airport-logical-model.png"/>

### Функциональные зависимости
Для простоты будем считать, что ФИО и Серия и номер паспорта пассажира являются атомарными атрибутами.
1. Табельный номер → ФИО, Количество вылетов, Должность, Номер экипажа, Группа допуска.
2. Номер экипажа → Группа допуска.
3. Номер рейса → Номер экипажа, Место назначения, Дата вылета, Дата прибытия, Бортовой номер.
4. Бортовой номер → Модель.
5. Модель → Группа допуска, Топливо, Длина разбега, Взлётная масса, Потолок, Количество посадочных мест, Скорость.
6. Табельный номер кассира → ФИО кассира.
7. Номер билета → Цена, Табельный номер кассира, Серия и номер паспорта пассажира, Номер рейса.
8. Серия и номер паспорта пассажира → ФИО пассажира.

Заметим, что все существующие зависимости являются функционально полными и нет частичных и транзитивных зависимостей.

В отношениях значения, определяемые каждым атрибутом, являются атомарными, каждый неключевой атрибут функционально полно зависит от первичного ключа, каждый неключевой атрибут нетранзитивно зависит от первичного ключа – эти отношения находятся в 3-ей нормальной форме.

## Создание таблиц и ограничений целостности. Использование команд SQL для работы с данными, хранящимися в таблицах <a name="db21"></a>
Знакомство с возможностями СУБД по созданию таблиц. Приобретение практических навыков использования языка SQL.
### Порядок выполнения работы
1. Выберите необходимую СУБД, для которой нужно создать схему данных.
2. Внесите необходимые изменения в имена таблиц, полей, связей и их свойства.
3. Проверьте и внесите необходимые изменения в типы данных полей.
4. Проверьте и внесите необходимые изменения в ограничения целостности данных.
5. Сгенерируйте DDL-скрипт для создания схемы данных в выбранной СУБД.
6. Внесите необходимые изменения в созданный DDL-скрипт.
7. Выполните DDL-скрипт и заполните созданные таблицы данными командой SQL Insert (минимум 10 записей на таблицу).
8. Создайте необходимые SQL-запросы, выполняющие основные требования к функциям системы.
9. Обдумайте и создайте запросы, которые, возможно, будут полезными для будущих пользователей вашей базы данных.
10. Приведите примеры запросов с выборкой, сортировкой, группировкой, левым, правым и внешним объединением.
11. Оформите отчет о выполнении лабораторной работы.
### SQL-запросы
1. Выдать расписание аэропорта на определённую дату.
2. Выдать список самолетов, имеющих более 200 посадочных мест.
3. В связи c участившимися террористическими актами для охранных служб аэропорта создаётся запрос на выборку, в котором отражается информация о том, сколько и кому каждый кассир продал билетов на какой рейс.
4. Выдать информацию об экипаже, назначенном на определённый рейс.
5. Выдать список самолётов, совершивших полёты в определённый день.
6. Выдать список всех направлений, по которым осуществляются авиаперевозки.
7. Расписание для информационного табло аэропорта.
8. Для обслуживания самолёта.
9. Для службы безопасности.
10. Вывести список моделей самолетов и их вместимость в порядке убывания вместимости.
11. Вывести фамилии пилотов, у которых количество вылетов больше 50 и упорядочить по фамилии.
12. Вывести все имеющиеся самолёты марки Boeing.
13. Вывести модели самолётов, назначенные на рейсы.
14. Вывести пофамильный состав всех экипажей.

## Создание и использование хранимых процедур и функций <a name="db22"></a>
Знакомство с возможностями СУБД по созданию хранимых процедур и функций.
### Порядок выполнения работы:
1.	Создайте хранимые процедуры:
a)	без параметров, с использованием агрегатных функций;
b)	с входным параметром/параметрами;
c)	с входными и выходными параметрами.
2.	Создайте хранимые процедуры для добавления и изменения записей в таблицах, проверяющих существование редактируемой записи и определяющие значение суррогатного первичного ключа по умолчанию для новых записей.
3.	Внесите такие изменения в хранимые процедуры добавления и изменения записей в таблицах, которые не позволят добавить или изменить записи с дублирующими названиями.
4.	Создайте хранимые процедуры удаления записей из таблиц, удаляющих связанные записи из дочерних таблиц.
5.	Проверьте работоспособность всех созданных хранимых процедур.
6.	Создайте функцию:
a)	возвращающую скалярное значение (тип функции Scalar);
b)	возвращающую набор данных Table (тип функции Inline);
c)	многооператорную функцию, возвращающую таблицу (тип функции Multi-statement).
7.	Проверьте работоспособность всех созданных функций.

## Создание и использование тригеров и курсоров <a name="db23"></a>
Знакомство с возможностями СУБД по созданию триггеров и курсоров.
### Порядок выполнения работы:
1.	Создайте триггер:
a)	запрещающий вставку в таблицу новой строки с заданным параметром;
b)	запрещающий изменение заданного поля.
2.	Внесите изменения в ранее созданный триггер.
3.	Создайте необходимые последовательности для суррогатных первичных ключей.
4.	Создайте триггеры вставки и изменения записей таблиц, определяющие значение суррогатного первичного ключа по умолчанию.
5.	Создайте триггер ведения аудита изменения записей в таблицах.
6.	Внесите такие изменения в триггеры вставки и изменения записей таблиц, которые не позволят добавить или изменить записи с дублирующими названиями.
7.	Создайте триггеры для не обновляемых представлений, позволяющие изменять данные.
8.	Создайте курсор для вывода записей из таблицы, удовлетворяющих заданному условию.
9.	Создайте курсор, используемый как выходной параметр процедуры.

## Разработка системы защиты информации на основе привилегий <a name="db24"></a>
Знакомство с возможностями СУБД по защите информации на основе привилегий.
### Порядок выполнения работы:
1.	Создайте нового пользователя и предоставьте ему привилегии на выборку информации из созданных вами представлений и запуска процедур.
2.	Соединитесь с СУБД от имени нового пользователя и проверьте возможность доступа к вашим данным через представления и запуск процедур.
3.	Проверьте невозможность доступа к вашим данным через таблицы и хранимые процедуры.
4.	Соединитесь с СУБД от своего имени и предоставьте новому пользователю привилегии на выборку, вставку, изменение и удаление данных из ваших таблиц.
5.	Соединитесь с СУБД от имени нового пользователя и проверьте возможность изменения данных в созданных вами таблицах.
6.	Соединитесь с СУБД от своего имени и отберите у нового пользователя все предоставленные ему привилегии.
7.	Соединитесь с СУБД от имени нового пользователя и проверьте невозможность изменения данных в созданных Вами таблицах и запуск ваших хранимых процедур.

## Проектирование распределённой базы данных <a name="db30"></a>

Организация занимается поставками молочной продукции.
Организация характеризуется 
* ИНН, 
* наименованием, 
* телефоном, 
* адресом,
* фамилией директора, 
* фамилией менеджера, ответственного за поставки.

Молочная продукция характеризуется 
* названием, 
* % жирности,
* стоимостью. 

Потребителями продукции являются другие организации, характеризующиеся 
* различным видом собственности (государственные учреждения, муниципальные учреждения, ООО, ОАО, ИП).

### Проектирование распределённой базы данных

<img src="/about/products-er-model.png"/>

<img src="/about/products-logical-model.png"/>

1. Для заданной предметной области построить ER-модель, выделить
сущности, описать атрибуты каждой сущности, установить связи
между сущностями.
2. Разработать схему базы данных. При необходимости произвести
нормализацию отношений.
3. При построении физической структуры базы данных согласовать
другими вариантами название полей, их идентификаторов и типов
данных для всех сущностей (общие во всех вариантах поля должны
иметь одинаковые идентификаторы)
4. Реализовать полученную схему. При создании дать имя базе данных по имени
соответствующей рабочей станции (например, WS1, WS2 и WS3).
5. Заполнить таблицы данными (не менее 10 записей в каждой балице
базы данных. При этом данные о поставщиках и потребителях не
должны совпадать на разных рабочих станциях).
